<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>設備資料設定</title>
  <base href="/deviceManager/">
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <!-- IonIcons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
   <!-- DataTables -->
   <link rel="stylesheet" href="plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
   <link rel="stylesheet" href="plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
   <link rel="stylesheet" href="plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
  <style>
    .nav-tabs { margin-bottom: 20px;}
  </style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
  <!-- Navbar-->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
     <!-- 上方行列 -->
     <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="index.html" class="nav-link">回首頁</a>    
      </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">         
      <li class="nav-item">
        <a class="nav-link" data-widget="fullscreen" href="#" role="button">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>
      <!-- <li class="nav-item">
        <a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
          <i class="fas fa-th-large"></i>
        </a>
      </li> -->
    </ul>
  </nav>

  <!-- Main Sidebar Container 側邊欄位 -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <a href="index.html" class="brand-link">
      <img src="dist/img/device01.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
      <span class="brand-text font-weight-light">設備監控管理後台</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar user (optional) -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          <img src="dist/img/userNobody.png" class="img-circle elevation-2" alt="User Image">
        </div>
        <div class="info">
          <a href="#" class="d-block">登入者姓名</a>
        </div>
      </div>

      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul id="sidebarMenu" class="nav nav-pills nav-sidebar flex-column"
          data-widget="treeview" role="menu" data-accordion="false">
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6">
            <h1>設備資料設定總覽頁</h1>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="index.html">首頁</a></li>
              <li class="breadcrumb-item active">基本管理 / 設備資料設定</li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">                            
        <div class="card card-default card-outline">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-th-large"></i>
              設備資料
            </h3>
          </div>
          <div class="card-body">
            <!--表頭內容-->
            <h4>透過設備類型分頁</h4>
            <ul class="nav nav-tabs" id="custom-content-below-tab" role="tablist"></ul>
            <!--表身內容-->
            <div class="tab-content" id="custom-content-below-tabContent"></div>                    
          </div>
        </div>
      </div>
    </section>
  </div>
  <footer class="main-footer">
    <div class="float-right d-none d-sm-block">
      <b>Version</b> 3.2.0
    </div>
    <strong>Copyright &copy; 2014-2024 
      <a href="https://www.leosys.com/">國眾電腦股份有限公司</a>.
    </strong> All rights reserved.
  </footer> 
</div>

<input type="file" id="hiddenFileInput" class="d-none" accept=".xlsx,.xls">

<!-- jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script> 

<!-- DataTables  & Plugins -->
<script src="plugins/datatables/jquery.dataTables.min.js"></script>
<script src="plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
<script src="plugins/jszip/jszip.min.js"></script>
<script src="plugins/pdfmake/pdfmake.min.js"></script>
<script src="plugins/pdfmake/vfs_fonts.js"></script>
<script src="plugins/datatables-buttons/js/buttons.html5.min.js"></script>
<script src="plugins/datatables-buttons/js/buttons.print.min.js"></script>
<script src="plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
<!-- AdminLTE App -->
<script src="dist/js/adminlte.min.js"></script>
<!-- 假資料存放區 -->
<script src="data/device_info.js"></script>
<!-- 左側欄動態生成 -->
<script src="data/sidebar_menu.js"></script>
<script src="js/sidebar.js"></script>
<script>
  $(function () {
    // 將 deviceTypeList 轉換成需要的格式
    const typeList = deviceTypeList.map((device, index) => ({
        deviceId: `Device${(index + 1).toString().padStart(2, '0')}`,  // 自動生成設備 ID
        deviceType: device.deviceType,
        paramValue: device.paramValue,
        applyDate: device.applyDate,
        modId: device.modId
    }));

    // 整合 deviceDataList 與 deviceDataCheckList
    const allDeviceDataList = [...deviceDataList, ...deviceDataCheckList];

    const tabList = $("#custom-content-below-tab");
    const tabContent = $("#custom-content-below-tabContent");
    tabList.empty();
    tabContent.empty();

    // 分頁與內容生成
    typeList.forEach((device, index) => {
      const isActive = index === 0 ? "active" : "";
      const deviceId = device.deviceId;
      const deviceType = device.deviceType;

      // 分頁標籤
      tabList.append(`
        <li class="nav-item">
          <a class="nav-link ${isActive}" id="tab-${deviceId}" data-toggle="pill" href="#content-${deviceId}" 
            role="tab" aria-controls="content-${deviceId}" aria-selected="${index === 0}">
            ${deviceType}
          </a>
        </li>
      `);

        // 分頁內容
        tabContent.append(`
          <div class="tab-pane fade show ${isActive}" id="content-${deviceId}" role="tabpanel">
            <section class="content">
              <div class="container-fluid">
                <div class="row"><div class="col-12">
                  <div class="card"><div class="card-body">
                    <table id="table-${deviceId}" class="table table-bordered table-hover">
                      <thead>
                        <tr>
                          <th>設備編號</th><th>設備名稱</th>
                          <th>設備類別</th><th>所屬單位</th>
                          <th>維護人員 / 審核人員</th><th>功能</th>
                        </tr>
                      </thead>
                      <tbody id="deviceTableBody-${deviceId}"></tbody>
                    </table>
                  </div></div>
                </div></div>
              </div>
            </section>
          </div>
        `);

        renderDeviceTable(deviceId, `deviceTableBody-${deviceId}`, deviceType);
        initializeDataTable(`table-${deviceId}`, deviceType);
    });

    // 通用渲染函數
    function renderDeviceTable(deviceId, tableBodyId, deviceType) {
      const tableBody = document.getElementById(tableBodyId);
      tableBody.innerHTML = allDeviceDataList
        .filter(d => d.deviceId === deviceId)
        .sort((a, b) => (statusMap[a.status]?.order || 99) - (statusMap[b.status]?.order || 99))
        .map(d => {
          // 根據狀態設定「修改」按鈕
          let editButton = "";
          if (d.status === "審核中") {
            editButton = `<span class="btn btn-sm btn-secondary disabled" 
                            style="pointer-events:auto; cursor:pointer;" 
                            onclick="alert('設備 ${d.deviceNo} 為審核中不得修改')">修改</span>`;
          } else if (d.status === "退回") {
            editButton = `<span class="btn btn-sm btn-secondary disabled" 
                            style="pointer-events:auto; cursor:pointer;" 
                            onclick="alert('設備 ${d.deviceNo} 為退回不得修改，請重新申請')">修改</span>`;
          } else {
            editButton = `<a href="deviceDataEdit.html?id=${d.deviceNo}&deviceType=${deviceType}" 
                            class="btn btn-sm btn-secondary">修改</a>`;
          }
        
          return `
            <tr>
              <td>${d.deviceNo}</td>
              <td>${d.deviceName}</td>
              <td>${d.deviceType}</td>
              <td>${d.organId} - ${d.organName}</td>
              <td>${d.modId} / ${d.cofId}</td>
              <td style="text-align:center;">
                <a href="deviceDataEdit.html?id=${d.deviceNo}&readonly=true&deviceType=${deviceType}" class="btn btn-sm btn-primary">檢視</a>
                ${editButton}
                <button class="btn btn-sm btn-danger" onclick="deleteDevice('${d.deviceNo}')">刪除</button>
              </td>
            </tr>
          `;
        }).join("")   
    }

    // DataTable 初始化
    function initializeDataTable(tableId, deviceType) {
      $(`#${tableId}`).DataTable({
        responsive: true,
        lengthChange: false,
        autoWidth: false,
        ordering: false,
        columnDefs: [{
          targets: 2,
          render: (data) => `<span style="color:${statusMap[data]?.color || 'black'}">${data}</span>`
        }],
        buttons: [
          {
            text: '單一新增',
            className: 'btn btn-secondary ',
            action: () => window.location.href = `deviceDataAdd.html?deviceType=${deviceType}`
          },     
          {
            text:'<div class="custom-file">'+
                    '<input type="file" class="custom-file-input" id="customFile">'+
                    '<label class="custom-file-label text-left" for="customFile">新增批量上傳(限Excel)</label>'+
                  '</div>',
            className: 'btn btn-secondary ',                
            action: uploadExcel
          }
        ],
        language: {
          "lengthMenu": "每頁顯示 _MENU_ 筆",
          "zeroRecords": "查無資料",
          "info": "顯示第 _START_ 筆到第 _END_ 筆，共 _TOTAL_ 筆",
          "infoFiltered": "(從 _MAX_ 筆資料過濾)",
          "search": "搜尋：",
          "paginate": {
            "first": "第一頁",
            "last": "最後一頁",
            "next": "下一頁",
            "previous": "上一頁"
          },
        }
      }).buttons().container().appendTo(`#${tableId}_wrapper .col-md-6:eq(0)`);
    }
    
    // Excel 上傳模擬
    function uploadExcel() {
      const input = $('<input>', {
        type: 'file',
        accept: '.xlsx, .xls',
        class: 'd-none',
        change: function (event) {
          const file = event.target.files[0];
          if (file) {
            const fileName = file.name;
            const extension = fileName.split('.').pop().toLowerCase();
            if (extension === 'xlsx' || extension === 'xls') {
              $('label[for="customFile"]').text(fileName);

              // 模擬送出
              const formData = new FormData();
              formData.append('file', file);

              // 模擬 ajax 上傳
              $.ajax({
                url: '/api/device/batch-upload', // TODO: 替換成實際 API
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: () => alert("上傳成功！"),
                error: () => alert("上傳失敗，請確認檔案格式與內容")
              });

            } else {
              alert('錯誤：只允許上傳 Excel 文件 (.xls, .xlsx)');
            }
          }
        }
      });
      input.appendTo('body').click();
    }

    // 載入時自動選中對應分頁
    const urlParams = new URLSearchParams(window.location.search);
    const selectedType = urlParams.get("deviceType");
    if (selectedType) {
      const selectedTab = typeList.find(t => t.deviceType === selectedType);
      if (selectedTab) {
        $(`#tab-${selectedTab.deviceId}`).tab('show');
        // 模擬點擊分頁
        setTimeout(() => {
        }, 0); // 確保頁面分頁渲染完成後再觸發切換
      }
    }

  });

  // 刪除設備
  function deleteDevice(devicenNumber) {
      alert(`設備 ${devicenNumber} 已刪除！（此功能需連接後端）`);
  }
</script>
</body>
</html>
