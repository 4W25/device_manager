<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>設備版本軟體設定</title>

	<link rel="stylesheet"
		href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
	<link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
	<link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
	<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
	<style>
		.nav-tabs {
			margin-bottom: 20px;
		}
	</style>
</head>

<body class="hold-transition sidebar-mini">
	<div class="wrapper">
		<nav class="main-header navbar navbar-expand navbar-white navbar-light">
			<ul class="navbar-nav">
				<li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#" role="button"><i
							class="fas fa-bars"></i></a></li>
				<li class="nav-item d-none d-sm-inline-block"><a href="../../DeviceIndex.html" class="nav-link">回首頁</a>
				</li>
			</ul>
			<ul class="navbar-nav ml-auto">
				<li class="nav-item"><a class="nav-link" data-widget="fullscreen" href="#" role="button"> <i
							class="fas fa-expand-arrows-alt"></i>
					</a></li>
			</ul>
		</nav>

		<aside class="main-sidebar sidebar-dark-primary elevation-4">
			<a href="../../DeviceIndex.html" class="brand-link"> <img src="../../dist/img/device01.png"
					alt="AdminLTE Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
				<span class="brand-text font-weight-light">設備監控管理後台</span>
			</a>
			<div class="sidebar">
				<div class="user-panel mt-3 pb-3 mb-3 d-flex">
					<div class="image">
						<img src="../../dist/img/userNobody.png" class="img-circle elevation-2" alt="User Image">
					</div>
					<div class="info">
						<a href="#" class="d-block">登入者姓名</a>
					</div>
				</div>
				<nav class="mt-2">
					<ul id="sidebarMenu" class="nav nav-pills nav-sidebar flex-column" data-widget="treeview"
						role="menu" data-accordion="false">
					</ul>
				</nav>
			</div>
		</aside>
		<div class="content-wrapper">
			<section class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1>設備版本軟體設定總覽頁</h1>
						</div>
						<div class="col-sm-6">
							<ol class="breadcrumb float-sm-right">
								<li class="breadcrumb-item"><a href="../../DeviceIndex.html">首頁</a></li>
								<li class="breadcrumb-item active">設備軟體派送管理 / 設備版本軟體設定</li>
							</ol>
						</div>
					</div>
				</div>
			</section>

			<section class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div class="card">
								<div class="card-header">
									<h3 class="card-title">
										<i class="fas fa-th-large"></i> 設備版本軟體設定表
									</h3>
								</div>
								<div class="card-body">
									<!--表頭內容-->
									<h4>透過設備類型分頁</h4>
									<ul class="nav nav-tabs" id="custom-content-below-tab" role="tablist"></ul>
									<!--表身內容-->
									<div class="tab-content" id="custom-content-below-tabContent"></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>
		<footer class="main-footer">
			<div class="float-right d-none d-sm-block">
				<b>Version</b> 3.2.0
			</div>
			<strong>Copyright &copy; 2014-2024 <a href="https://www.leosys.com/">國眾電腦股份有限公司</a>.
			</strong> All rights reserved.
		</footer>
	</div>

	<!-- 更新彈跳視窗 -->
	<div class="modal fade" id="modal-default">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">更新狀態</h4>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p>One fine body&hellip;</p>
				</div>
				<div class="modal-footer justify-content-between">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
				</div>
			</div>
		</div>
	</div>
	<script src="../../plugins/jquery/jquery.min.js"></script>
	<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
	<script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
	<script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
	<script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
	<script src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
	<script src="../../plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
	<script src="../../plugins/jszip/jszip.min.js"></script>
	<script src="../../plugins/pdfmake/pdfmake.min.js"></script>
	<script src="../../plugins/pdfmake/vfs_fonts.js"></script>
	<script src="../../plugins/datatables-buttons/js/buttons.html5.min.js"></script>
	<script src="../../plugins/datatables-buttons/js/buttons.print.min.js"></script>
	<script src="../../plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
	<script src="../../dist/js/adminlte.min.js"></script>
	<script src="../../dist/js/demo.js"></script>
	<!-- 假資料存放區 -->
	<script src="../../data/device_info.js"></script>
	<!-- 左側欄動態生成 -->
	<script src="../../data/sidebar_menu.js"></script>
	<script src="../../js/sidebar.js"></script>
	<script>
		$(function () {
			// 將 deviceTypeList 轉換成需要的格式
			const typeList = deviceTypeList.map((device, index) => ({
				verNo: `Device${(index + 1).toString().padStart(2, '0')}`,  // 自動生成設備 ID
				deviceType: device.deviceType,
				paramValue: device.paramValue,
				applyDate: device.applyDate,
				modId: device.modId
			}));

			const tabList = $("#custom-content-below-tab"); // 設備類型分頁
			const tabContent = $("#custom-content-below-tabContent");  // 設備資料明細
			tabList.empty();
			tabContent.empty();

			// 分頁標籤
			typeList.forEach((device, index) => {
				const isActive = index === 0 ? "active" : "";

				// 自動生成分頁
				tabList.append(`
            <li class="nav-item">
              <a class="nav-link ${isActive}" id="tab-${device.verNo}" data-toggle="pill" href="#content-${device.verNo}" 
                 role="tab" aria-controls="content-${device.verNo}" aria-selected="${index === 0}">
                ${device.deviceType}
              </a>
            </li>
        `);

				// 自動生成內容區域
				tabContent.append(`
    <div class="tab-pane fade show ${isActive}" id="content-${device.verNo}" 
         role="tabpanel" aria-labelledby="tab-${device.verNo}">
      <section class="content">
        <div class="container-fluid">
          <div class="row">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <div class="row mb-2">
                  <div class="col-12 text-end">
                  <button type="button" class="btn btn-primary me-3" data-toggle="modal" data-target="#uploadProgramModal">上傳程式</button>
                </div>

                  </div>
                  <table id="table-${device.verNo}" class="table table-bordered table-hover">
                    <thead>
                      <tr>
                        <th>設備類型</th>
                        <th>軟體版本號</th>
                        <th>上版時間</th>
                        <th>是否必要更新</th>
                        <th>前置版本</th>
                        <th>更新類型</th>
                        <th>更新內容描述</th>
                        <th>下載</th>
                      </tr>
                    </thead>
                    <tbody id="deviceTableBody-${device.verNo}"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
`);


				// 渲染設備表格
				renderDeviceTable(device.verNo, `deviceTableBody-${device.verNo}`, device.deviceType);
				// 初始化 DataTable
				initializeDataTable(`table-${device.verNo}`, device.deviceType);

			});


			function renderDeviceTable(verNo, tableBodyId, deviceType) {
				const tableBody = document.getElementById(tableBodyId);
				tableBody.innerHTML = ""; // 清空表格

				// 篩選該設備類型的資料
				const filteredData = versionInfo.filter(data => data.deviceType === deviceType);

				// 依照 verNo 分組，每組取 updateTime 最大的那筆
				const latestDataMap = {};

				filteredData.forEach(data => {
					const existing = latestDataMap[data.verNo];
					if (!existing || new Date(data.updateTime) > new Date(existing.updateTime)) {
						latestDataMap[data.verNo] = data;
					}
				});

				// 渲染每台設備最新的一筆
				Object.values(latestDataMap)
					.sort((a, b) => new Date(b.updateTime) - new Date(a.updateTime)) // 整體按照時間排序
					.forEach(data => {
						const row = `
        <tr>
       <td>${data.deviceType}</td>
       <td>${data.verNo}</td>
       <td>${data.updateTime}</td>
       <td>${data.isMandatory}</td>
       <td>${data.previousVer}</td>
       <td>${data.updateType}</td>
       <td>${data.releaseNotes}</td>
       <td>
       <a href="${data.filePath}" download class="btn btn-sm btn-success">
           <i class="fas fa-download"></i> 下載
       </a>
   </td>
        </tr>
      `;
						tableBody.innerHTML += row;
					});
			}


			function initializeDataTable(tableId, deviceType) {
				$(`#${tableId}`).DataTable({
					responsive: true,
					lengthChange: true,
					ordering: false,
					autoWidth: false,
					buttons: ["copy", "csv", "excel", "pdf", "print", "colvis"],
					language: {
						"lengthMenu": "每頁顯示 _MENU_ 筆",
						"zeroRecords": "查無資料",
						"info": "顯示第 _START_ 筆到第 _END_ 筆，共 _TOTAL_ 筆",
						"infoFiltered": "(從 _MAX_ 筆資料過濾)",
						"search": "搜尋：",
						"paginate": {
							"first": "第一頁",
							"last": "最後一頁",
							"next": "下一頁",
							"previous": "上一頁"
						},
					}
				}).buttons().container().appendTo(`#${tableId}_wrapper .col-md-6:eq(0)`);
			}

			const urlParams = new URLSearchParams(window.location.search);
			const selectedType = urlParams.get("deviceType");
			if (selectedType) {
				const selectedTab = typeList.find(t => t.deviceType === selectedType);
				if (selectedTab) {
					$(`#tab-${selectedTab.verNo}`).tab('show');
					setTimeout(() => {
					}, 0); // 確保頁面分頁渲染完成後再觸發切換
				}
			}

		});

		function updateSystem(deviceNo) {
			const modalBody = document.querySelector('#modal-default .modal-body');
			modalBody.innerHTML = `<p>設備 ${deviceNo} 確認更新中...</p>`;
		}

	</script>
	<script>
		$(document).ready(function () {
			// 顯示選擇檔案名稱
			$('#programFile').on('change', function () {
				var fileName = $(this).val().split('\\').pop();
				$(this).next('.custom-file-label').html(fileName);
			});

			// 提交表單
			$('#uploadProgramForm').on('submit', function (e) {
				e.preventDefault();

				const formData = new FormData(this);

				$.ajax({
					url: '/uploadProgram', // 你的後端處理路徑
					type: 'POST',
					data: formData,
					processData: false,
					contentType: false,
					success: function (res) {
						alert('上傳成功！');
						$('#uploadProgramModal').modal('hide');
						// 可加刷新程式列表等邏輯
					},
					error: function () {
						alert('上傳失敗，請確認檔案格式與大小。');
					}
				});
			});
		});
	</script>

	<!-- 上傳程式檔案的 Modal -->
	<div class="modal fade" id="uploadProgramModal" tabindex="-1" role="dialog" aria-labelledby="uploadProgramLabel"
		aria-hidden="true">
		<div class="modal-dialog" role="document">
			<form id="uploadProgramForm" enctype="multipart/form-data">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="uploadProgramLabel">上傳程式檔案</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span>&times;</span>
						</button>
					</div>
					<div class="modal-body">

						<!-- 						<div class="form-group"> -->
						<!-- 							<label for="programName">程式名稱</label> <input type="text" -->
						<!-- 								class="form-control" id="programName" name="programName" -->
						<!-- 								placeholder="輸入程式名稱"> -->
						<!-- 						</div> -->

						<div class="form-group">
							<label for="deviceTypeFilter">設備類型：</label> <select id="deviceTypeFilter"
								class="form-control">
								<option value="ATM">ATM系統</option>
								<option value="Biometric">TCR系統</option>
								<option value="門禁系統">門禁系統</option>
								<option value="指紋辨識">監控辨識</option>
							</select>
						</div>

						<div class="form-group">
							<label for="programFile">選擇程式檔案</label>
							<div class="input-group">
								<div class="custom-file">
									<input type="file" class="custom-file-input" id="programFile" name="programFile"
										accept=".exe,.zip,.rar,.jar,.war,.sh,.bat">
									<label class="custom-file-label" for="programFile">選擇檔案</label>
								</div>
							</div>
						</div>
						<div class="form-group">
							<label for="programName">前置程式版本：</label> <select id="programName" class="form-control">
								<option value=""></option>
								<option value="無">無</option>
								<option value="初版程式">初版程式</option>
								<option value="atm_v1.0.0">atm_v1.0.0</option>
								<option value="atm_v1.0.5">atm_v1.0.5</option>
								<option value="atm_v1.0.6">atm_v1.0.6</option>
								<option value="atm_v1.0.7">atm_v1.0.7</option>
								<option value="atm_v1.1.0">atm_v1.1.0</option>
								<option value="atm_v2.0.0">atm_v2.0.0</option>
							</select>
						</div>
						<div class="form-group">
							<label for="programName">上傳程式版本</label> <input type="text" class="form-control"
								id="programName" name="programName" placeholder="輸入程式版本">
						</div>

						<div class="form-group">
							<label for="description">說明</label>
							<textarea class="form-control" id="description" name="description" rows="3"
								placeholder="可輸入上傳用途、版本說明..."></textarea>
						</div>

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
						<button type="submit" class="btn btn-primary">開始上傳</button>
					</div>
				</div>
			</form>
		</div>
	</div>

</body>

</html>