<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>設備軟體版本設定 - 覆核</title>

<link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
<link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
<link rel="stylesheet" href="../../dist/css/adminlte.min.css">
<style>
  .nav-tabs { margin-bottom: 20px; }
  .badge-status { padding: .35em .6em; border-radius: .25rem; color: #fff; }
</style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a></li>
      <li class="nav-item d-none d-sm-inline-block"><a href="../../index.html" class="nav-link">回首頁</a></li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item"><a class="nav-link" data-widget="fullscreen" href="#"><i class="fas fa-expand-arrows-alt"></i></a></li>
    </ul>
  </nav>

  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="../../index.html" class="brand-link">
      <img src="../../dist/img/device01.png" class="brand-image img-circle elevation-3" style="opacity:.8">
      <span class="brand-text font-weight-light">自動化設備管理平臺</span>
    </a>
    <div class="sidebar">
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image"><img src="../../dist/img/userNobody.png" class="img-circle elevation-2" alt="User"></div>
        <div class="info"><a href="#" class="d-block">登入者姓名</a></div>
      </div>
      <nav class="mt-2">
        <ul id="sidebarMenu" class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false"></ul>
      </nav>
    </div>
  </aside>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6"><h1>設備軟體版本設定 - 覆核</h1></div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="../../index.html">首頁</a></li>
              <li class="breadcrumb-item active">設備軟體版本設定 / 覆核</li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <div class="card">
          <div class="card-header"><h3 class="card-title"><i class="fas fa-th-large"></i> 待覆核版本列表</h3></div>
          <div class="card-body">
            <ul class="nav nav-tabs" id="device-tabs" role="tablist"></ul>
            <div class="tab-content" id="device-tabContent"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="main-footer">
    <div class="float-right d-none d-sm-block"><b>Version</b> 3.2.0</div>
    <strong>&copy; 2014-2024 <a href="https://www.leosys.com/">國眾電腦股份有限公司</a>.</strong> All rights reserved.
  </footer>
</div>

<!-- View Modal -->
<div class="modal fade" id="viewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="viewForm" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">上傳資料檢視</h5><button type="button" class="close" data-dismiss="modal">&times;</button></div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6"><label>設備型號</label><input type="text" class="form-control" id="m_deviceType" disabled></div>
          <div class="col-md-6"><label>版本號</label><input type="text" class="form-control" id="m_verNo" disabled></div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6"><label>上傳者</label><input type="text" class="form-control" id="m_uploadUser" disabled></div>
          <div class="col-md-6"><label>上傳時間</label><input type="text" class="form-control" id="m_uploadTime" disabled></div>
        </div>
        <div class="mt-3">
          <label>上傳 ZIP 檔案</label>
          <input type="text" class="form-control" id="m_fileName" disabled>
          <button id="btnDownloadZip" type="button" class="btn btn-secondary mt-2"><i class="fas fa-download"></i> 下載上傳檔案</button>
        </div>
		<div class="form-group">
          <div class="col-md-6"><label>說明</label><input type="text" class="form-control" id="m_releaseNotes" disabled></div>
        </div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button></div>
    </form>
  </div>
</div>

<script src="../../plugins/jquery/jquery.min.js"></script>
<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
<script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="../../dist/js/adminlte.min.js"></script>
<script src="../../js/sidebar.js"></script>
<script src="../../data/sidebar_menu.js"></script>
<script src="../../data/device_info.js"></script>

<script>
(function () {
  const createdTables = {};

  function buildTabs() {
    const tabList = $('#device-tabs').empty();
    const tabContent = $('#device-tabContent').empty();

    deviceTypeList.forEach((d, idx) => {
      const verNoKey = `Device${String(idx+1).padStart(2,'0')}`;
      const active = idx===0 ? 'active' : '';
      const tabId = `tab-${verNoKey}`;
      const contentId = `content-${verNoKey}`;

      tabList.append(`
        <li class="nav-item">
          <a class="nav-link ${active}" id="${tabId}" data-toggle="pill" href="#${contentId}" role="tab" aria-controls="${contentId}" aria-selected="${idx===0}">${d.deviceType}</a>
        </li>`);

      tabContent.append(`
        <div class="tab-pane fade ${active ? 'show active' : ''}" id="${contentId}" role="tabpanel" aria-labelledby="${tabId}">
          <section class="content p-2">
            <table id="table-${verNoKey}" class="table table-bordered table-hover review-table">
              <thead>
                <tr>
				  <th>類型名稱</th>
				  <th>型號代碼</th>
                  <th>版本號</th>
                  <th>上傳者</th>
                  <th>上傳時間</th>
                  <th>狀態</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </section>
        </div>`);

      renderTable(verNoKey, d.deviceType);
    });

    $('a[data-toggle="pill"]').on('shown.bs.tab', function(e){
      const href = $(e.target).attr('href');
      const table = $(href).find('table').attr('id');
      if(table && !createdTables[table]){
        createdTables[table] = initializeDataTable(table);
      } else if(table && createdTables[table]){
        createdTables[table].columns.adjust();
      }
    });
  }

  function renderTable(verNoKey, deviceType){
    const tbody = $(`#table-${verNoKey} tbody`).empty();
    deviceSWVerCheckList
      .filter(x=>x.status==='審核中' && x.deviceType===deviceType)
      .forEach(item=>{
        tbody.append(`
          <tr data-id="${item.id}">
		  <td>${item.deviceName}</td>
		  <td>${item.deviceModel}</td>
            <td>${item.verNo}</td>
            <td>${item.uploadUser}</td>
            <td>${item.updateTime}</td>
            <td><span class="badge badge-warning">${item.status}</span></td>
            <td>
              <button class="btn btn-primary btn-sm act-view" data-id="${item.id}">檢視</button>
              <button class="btn btn-success btn-sm act-ok" data-id="${item.id}">通過</button>
              <button class="btn btn-danger btn-sm act-reject" data-id="${item.id}">退回</button>
            </td>
          </tr>`);
      });
    createdTables[`table-${verNoKey}`] = initializeDataTable(`table-${verNoKey}`);
  }

  function initializeDataTable(tableId){
    return $(`#${tableId}`).DataTable({
      responsive:true,
      lengthChange:false,
      autoWidth:false,
      ordering:false,
      searching:true,
      language:{
        lengthMenu:"每頁顯示 _MENU_ 筆",
        zeroRecords:"查無資料",
        info:"顯示第 _START_ 筆到第 _END_ 筆，共 _TOTAL_ 筆",
        infoEmpty:"顯示第 0 筆資料",
        infoFiltered:"(從 _MAX_ 筆資料過濾)",
        paginate:{first:"第一頁",last:"最後一頁",next:"下一頁",previous:"上一頁"}
      }
    });
  }

  function bindActions(){
    $('.review-table tbody').on('click', '.act-view', function(){
      const id = $(this).data('id');
      const data = deviceSWVerCheckList.find(x=>x.id===id);
      if(!data) return;

      $('#m_deviceType').val(data.deviceType);
      $('#m_verNo').val(data.verNo);
      $('#m_uploadUser').val(data.uploadUser);
      $('#m_uploadTime').val(data.updateTime);
      $('#m_fileName').val(data.fileName);
      $('#btnDownloadZip').off().on('click', function(){
        const link = document.createElement('a');
        link.href = 'data:application/zip;base64,'+data.fileBase64;
        link.download = data.fileName;
        link.click();
      });
	  $('#m_releaseNotes').val(data.releaseNotes);

      $('#viewModal').modal('show');
    });

    $('.review-table tbody').on('click', '.act-ok', function(){ alert('審核通過（待串接後端）'); });
    $('.review-table tbody').on('click', '.act-reject', function(){ alert('已退回（待串接後端）'); });
  }

  $(function(){
    buildTabs();
    bindActions();
  });

})();
</script>
</body>
</html>
