<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>軟體派送排程</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- IonIcons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
  <style>
    .nav-tabs {
      margin-bottom: 20px;
    }
  </style>
</head>

<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <!-- Navbar-->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <!-- 上方行列 -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="../../index.html" class="nav-link">回首頁</a>
        </li>
      </ul>

      <!-- Right navbar links -->
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" data-widget="fullscreen" href="#" role="button">
            <i class="fas fa-expand-arrows-alt"></i>
          </a>
        </li>
      </ul>
    </nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container 側邊欄位 -->

    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <!-- Brand Logo -->
      <a href="../../index.html" class="brand-link">
        <img src="../../dist/img/device01.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
          style="opacity: .8">
        <span class="brand-text font-weight-light">自動化設備管理平臺</span>
      </a>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Sidebar user (optional) -->
        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
          <div class="image">
            <img src="../../dist/img/userNobody.png" class="img-circle elevation-2" alt="User Image">
          </div>
          <div class="info">
            <a href="#" class="d-block">登入者姓名</a>
          </div>
        </div>

        <!-- Sidebar Menu -->
        <nav class="mt-2">
          <ul id="sidebarMenu" class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
            data-accordion="false">
          </ul>
        </nav>
      </div>
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <section class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1>軟體派送排程總覽頁</h1>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="../../index.html">首頁</a></li>
                <li class="breadcrumb-item active">軟體派送管理 / 軟體派送排程</li>
              </ol>
            </div>
          </div>
        </div>
        <!-- /.container-fluid -->
      </section>

      <!-- Main content -->
      <section class="content">
        <div class="container-fluid">
          <div class="card card-default card-outline">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-th-large"></i>
                軟體派送排程
              </h3>
            </div>
            <div class="card-body">
              <!--表頭內容-->
              <!--表身內容-->
              <!-- Tab 清單容器 -->
              <ul class="nav nav-tabs" id="device-tabs" role="tablist"></ul>
              <!-- 每個 tab 對應的內容（由 JS 產生） -->
              <div class="tab-content" id="device-tab-content"></div>
            </div>
            <!-- /.card -->
          </div>
          <!-- /.card -->
        </div>
        <!-- /.container-fluid -->
      </section>
      <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    <footer class="main-footer">
      <div class="float-right d-none d-sm-block">
        <b>Version</b> 3.2.0
      </div>
      <strong>Copyright &copy; 2014-2024
        <a href="https://www.leosys.com/">國眾電腦股份有限公司</a>.
      </strong> All rights reserved.
    </footer>    
    <!-- Audit Modal -->
    <div class="modal fade" id="auditModal" tabindex="-1" role="dialog" aria-labelledby="auditModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content border-primary shadow-sm">
          <div class="modal-header">
            <h5 class="modal-title" id="auditModalLabel">簽核軌跡</h5>
              <button type="button" class="close text-white" data-dismiss="modal" aria-label="關閉">
                <span aria-hidden="true">&times;</span>               
              </button>
          </div>
          <div class="modal-body">
            <div class="list-group" id="auditModalBody">
            <!-- JS 填充資料 -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- ./wrapper -->

  <!-- jQuery -->
  <script src="../../plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables  & Plugins -->
  <script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
  <script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
  <script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
  <script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
  <script src="../../plugins/jszip/jszip.min.js"></script>
  <script src="../../plugins/pdfmake/pdfmake.min.js"></script>
  <script src="../../plugins/pdfmake/vfs_fonts.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.html5.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.print.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
  <!-- AdminLTE App -->
  <script src="../../dist/js/adminlte.min.js"></script>
  <!-- 假資料存放區 -->
  <script src="../../data/device_group.js"></script>
  <!-- 左側欄動態生成 -->
  <script src="../../data/sidebar_menu.js"></script>
  <script src="../../js/sidebar.js"></script>
  <script>

    const tableColumns = [
      { title: "類型名稱" },
      { title: "型號代碼" },
      { title: "排程編號" },
      { title: "派送版本" },
      { title: "排程日期" },
      { title: "已選設備/組別" },
      { title: "更新時間" },
      { title: "完成度" },
      { title: "功能", orderable: false }
    ];

    // 核心：初始化所有外層 tab（設備類型）
    deviceTypeList.forEach((type, index) => {
      const isActive = index === 0;
      createDeviceTypeTab(type, isActive);
      initInnerTables(type.deviceTypeCode);
    });

    function createDeviceTypeTab(type, isActive) {
      // 外層設備類型 tab
      $("#device-tabs").append(`
        <li class="nav-item">
          <a class="nav-link ${isActive ? "active" : ""}" data-toggle="pill" href="#pane-${type.deviceTypeCode}">
            ${type.deviceTypeName}（${type.deviceTypeCode}）
          </a>
        </li>
      `);

      // 外層 tab 內容（新增按鈕 + 內層審核狀態 tabs）
      $("#device-tab-content").append(`
        <div class="tab-pane fade ${isActive ? "show active" : ""}" id="pane-${type.deviceTypeCode}">     
        <!-- 新增按鈕 -->
        <div class="mb-3">
          <button class="btn btn-secondary" onclick="window.location.href='deviceScheduleAdd.html?typeCode=${type.deviceTypeCode}'">
            <i class="fas fa-pencil-alt"></i> 新增
          </button>
        </div>

        <!-- 內層：審核狀態 tabs（nav-tabs） -->
        <ul class="nav nav-tabs mb-3" id="review-tabs-${type.deviceTypeCode}" role="tablist">
          ${reviewStatus.map((r, idx) => `
            <li class="nav-item">
              <a class="nav-link ${idx === 0 ? "active" : ""}" data-toggle="pill"
                href="#pane-${type.deviceTypeCode}-${r.statusCode}">
                ${r.statusName}
              </a>
            </li>
          `).join("")}
        </ul>

        <!-- 內層 tab 內容 -->
        <div class="tab-content">
        ${reviewStatus.map((r, idx) => `
          <div class="tab-pane fade ${idx === 0 ? "show active" : ""}" id="pane-${type.deviceTypeCode}-${r.statusCode}">
            <table class="table table-bordered table-hover table-${type.deviceTypeCode}-${r.statusCode}">
              <thead><tr>${tableColumns.map(c => `<th>${c.title}</th>`).join("")}</tr></thead>
              <tbody></tbody>
            </table>
          </div>
        `).join("")}
        </div>
      </div>
      `);
    }

    // 初始化內層 table
    function initInnerTables(typeCode) {
      reviewStatus.forEach(r => {
        const selector = `.table-${typeCode}-${r.statusCode}`;
        $(selector).DataTable({
          data: getTableData(typeCode, r.statusCode),
          columns: tableColumns.map((c, idx) => ({ data: idx })),
          responsive: true,
          lengthChange: false,
          ordering: false,
          autoWidth: false,
          language: {
            search: "搜尋：",
            lengthMenu: "每頁顯示 _MENU_ 筆",
            zeroRecords: "查無資料",
            info: "顯示第 _START_ 筆到第 _END_ 筆，共 _TOTAL_ 筆",
            infoEmpty: "",
            infoFiltered: "",
            paginate: { first: "第一頁", last: "最後一頁", next: "下一頁", previous: "上一頁" }
          }

        });
      });
    }

    // 取得 table 資料
    function getTableData(typeCode, statusCode) {
      return deviceScheduleList
        .filter(d => d.deviceTypeCode === typeCode && d.reviewStatus === statusCode)
        .map(d => {
          const deviceType = deviceTypeList.find(t => t.deviceTypeCode === typeCode);
          const isReadOnly = (statusCode === 0 || statusCode === 2);
          const listBadge = [
            ...d.deviceIds.map(dev => `<span class="badge badge-secondary mr-1">${dev}</span>`),
            ...d.groupIds.map(grp => `<span class="badge badge-info mr-1">${grp}</span>`)
          ].join(" ");
          const auditBtn = (statusCode === 2)  ? `<button class="btn btn-sm btn-info mr-1" onclick="openAudit('${d.scheduleId}')">簽核軌跡</button>`: "";
          
          const percentage = d.totalDevices > 0 ? Math.floor((d.completedDevices / d.totalDevices) * 100) : 0;
          const completionHtml = `
            <div class="progress" style="height: 20px; background-color: #e9ecef;">
                <div class="progress-bar" role="progressbar" style="width: ${percentage}%;" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100">${percentage}%</div>
            </div>
            <small class="text-muted">${d.completedDevices} / ${d.totalDevices}</small>`;

          return [
            deviceType.deviceTypeName,
            deviceType.deviceTypeCode,
            d.scheduleId,
            d.sendVersion,
            d.scheduleDate,
            listBadge,
            d.updateTime,
            completionHtml,
            `<div class="d-flex justify-content-center">
              <a href="deviceScheduleEdit.html?Id=${d.scheduleId}&isView=true" class="btn btn-sm btn-primary mr-1">檢視</a> 
              <a href="deviceScheduleEdit.html?Id=${d.scheduleId}" class="btn btn-sm btn-secondary mr-1 ${isReadOnly ? "disabled" : ""}">修改</a>
              <button class="btn btn-sm btn-danger mr-1 ${isReadOnly ? "disabled" : ""}" onclick="deleteSchedule('${d.scheduleId}')">刪除</button>
              ${auditBtn}
             </div>`  
          ];
        });
    }

    /*
        function renderDispatchType(dispatchTypes) {
          if (!dispatchTypes || dispatchTypes.length === 0) return "-";
          return dispatchTypes.map(t => {
            const text  = (t === "PUSH") ? "由系統推送" : "設備請求"
            return `<span class="badge badge-secondary mr-1">${text}</span>`;
          }).join("");
        }
    */

    // 刪除設備軟體排程
    function deleteSchedule(scheduleId) {
      alert(`設備軟體排程 ${scheduleId} 已刪除！（此功能需連接後端）`);
    }


    function openAudit(scheduleId) {
      // 模擬簽核軌跡資料
      const auditData = [
        { item: "申請", time: "2025-05-15 10:00", userId: "S5678", user: "王小明" },
        { item: "核准", time: "2025-05-16 14:30", userId: "S1234", user: "張主管" }
      ];

      const body = $("#auditModalBody");
      body.empty();

      auditData.forEach(a => {
        // 根據 item 決定 badge 顏色
        let badgeClass = "badge-secondary"; // 預設
        if (a.item === "申請") badgeClass = "badge-warning";
        else if (a.item === "核准") badgeClass = "badge-primary";

        body.append(`
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-1"><span class="badge ${badgeClass} mr-2">${a.item}</span>${a.userId}-${a.user}</h6>
              <small class="text-muted">${a.time}</small>
            </div>
            <i class="fas fa-check-circle text-success"></i>
          </div>
        `);
      });

      $("#auditModal").modal("show");
    }



  </script>
</body>

</html>