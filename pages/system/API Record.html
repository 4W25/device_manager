<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>API 紀錄_分頁</title>

<link rel="stylesheet"
	href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
<link rel="stylesheet"
	href="../../plugins/fontawesome-free/css/all.min.css">
<link rel="stylesheet"
	href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet"
	href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
<link rel="stylesheet"
	href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
<link rel="stylesheet" href="../../plugins/select2/css/select2.min.css">
<link rel="stylesheet"
	href="../../plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
<link rel="stylesheet" href="../../dist/css/adminlte.min.css">

<style>
/* 基本樣式 */
.nav-tabs { margin-bottom: 20px; }
.table th, .table td { 
  vertical-align: middle !important; 
  text-align: center;       /* ✅ 表格內容置中 */
}
.filter-bar { 
  display:flex; 
  flex-wrap:wrap; 
  gap:10px; 
  margin-bottom:15px; 
  align-items:center; 
}
.filter-bar label { font-weight:600; margin:0; }
.filter-bar .form-control { min-width:150px; flex:1; }
@media (max-width:576px) {
  .filter-bar label, .filter-bar .form-control { width:100%; }
  .filter-bar button { width:48%; }
}

/* 查無資料列置中 */
#noDataRow td { 
  text-align:center; 
  color:#dc3545; 
  font-weight:bold; 
  background:#fff3f3; 
}

/* 分頁區置中 */
#pagination {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}
#pagination .text-muted { text-align: center; flex:1; }
#pagination ul.pagination { justify-content: center; margin:0; }


body { min-width: 1200px; text-align: center; }
.col-sm-2 h1 {
  text-align: left;   /* ✅ 強制靠左 */
  margin: 0;          /* 可選，避免多餘 margin */
}
/* Sidebar 菜單文字靠左 */
.nav-sidebar .nav-item > .nav-link {
  text-align: left;      /* 文字靠左 */
  padding-left: 1rem;    /* 左側內距，可根據需求調整 */
}

.nav-sidebar .nav-item {
  justify-content: flex-start; /* 去掉預設的對齊方式 */
}


</style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" data-widget="pushmenu"
        href="#"><i class="fas fa-bars"></i></a></li>
      <li class="nav-item d-none d-sm-inline-block"><a
        href="../../index.html" class="nav-link">回首頁</a></li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item"><a class="nav-link"
        data-widget="fullscreen" href="#"><i class="fas fa-expand-arrows-alt"></i></a></li>
    </ul>
  </nav>

  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="../../index.html" class="brand-link"> <img
      src="../../dist/img/device01.png" alt="Logo"
      class="brand-image img-circle elevation-3" style="opacity: .8">
      <span class="brand-text font-weight-light">自動化設備管理平臺</span>
    </a>
    <div class="sidebar">
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          <img src="../../dist/img/userNobody.png"
            class="img-circle elevation-2" alt="User Image">
        </div>
        <div class="info">
          <a href="#" class="d-block">登入者姓名</a>
        </div>
      </div>
      <nav class="mt-2">
        <ul id="sidebarMenu" class="nav nav-pills nav-sidebar flex-column"
          data-widget="treeview" role="menu" data-accordion="false">
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-2  "><h1>API 紀錄總覽</h1></div>
          <div class="col-sm-10">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="../../index.html">首頁</a></li>
              <li class="breadcrumb-item active">API 紀錄</li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid card card-default card-outline">
        <div class="card-header"><h3 class="card-title"><i class="fas fa-server"></i> API 紀錄資料</h3></div>
        <div class="card-body">
          <!-- 篩選條件 -->
          <div class="filter-bar">
            <label for="startDate">起始日期：</label><input type="date" id="startDate" class="form-control">
            <label for="endDate">結束日期：</label><input type="date" id="endDate" class="form-control">
            <label for="userInput">使用者：</label><input type="text" id="userInput" class="form-control" placeholder="輸入使用者">
            <label for="apiNameSelect">API 名稱：</label><select id="apiNameSelect" class="form-control"><option value="">全部</option></select>
            <label for="statusSelect">執行結果：</label>
            <select id="statusSelect" class="form-control"><option value="">全部</option><option value="S">S</option><option value="F">F</option></select>
            <button class="btn btn-primary" onclick="filterTable()">查詢</button>
            <button class="btn btn-secondary" onclick="resetFilter()">重設</button>
          </div>

          <!-- Tab 分頁 -->
          <ul class="nav nav-tabs" id="apiTab" role="tablist"></ul>
          <div class="tab-content" id="apiTabContent"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Footer -->
  <footer class="main-footer">
    <div class="float-right d-none d-sm-block"><b>Version</b> 3.2.0</div>
    <strong>&copy; 2014-2024 <a href="https://www.leosys.com/">國眾電腦股份有限公司</a>.</strong> All rights reserved.
  </footer>
</div>

<!-- 詳細 Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">API 詳細資料</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body" id="modalBodyContent"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">關閉</button>
      </div>
    </div>
  </div>
</div>

<script src="../../plugins/jquery/jquery.min.js"></script>
<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
<script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="../../plugins/select2/js/select2.full.min.js"></script>
<script src="../../dist/js/adminlte.min.js"></script>
<script src="../../js/sidebar.js"></script>
<script src="../../data/sidebar_menu.js"></script>

<script>
/*API 原始資料*/
const apiData = [
{time:'2025-11-20 10:00:00', user:'A001', api:'Login', result:'S', ip:'192.168.1.10', type:'Auth', detail:'登入成功'},
{time:'2025-11-20 10:05:00', user:'A002', api:'GetData', result:'F', ip:'192.168.1.12', type:'Data', detail:'資料不存在'},
{time:'2025-11-20 10:10:00', user:'A003', api:'Update', result:'S', ip:'192.168.1.13', type:'Data', detail:'更新成功'},
{time:'2025-11-18 09:12:30', user:'A001', api:'Login', result:'S', ip:'192.168.1.10', type:'Auth', detail:'登入成功'},
{time:'2025-11-19 15:45:10', user:'A002', api:'Login', result:'F', ip:'192.168.1.11', type:'Auth', detail:'密碼錯誤'},
{time:'2025-11-20 11:30:55', user:'A003', api:'Login', result:'S', ip:'192.168.1.12', type:'Auth', detail:'登入成功'},
{time:'2025-11-20 14:05:20', user:'A004', api:'Logout', result:'S', ip:'192.168.1.13', type:'Auth', detail:'登出成功'},
{time:'2025-11-21 08:50:00', user:'A005', api:'Login', result:'F', ip:'192.168.1.14', type:'Auth', detail:'帳號不存在'},

{time:'2025-11-18 10:20:15', user:'B001', api:'GetData', result:'S', ip:'192.168.2.10', type:'Data', detail:'取得資料成功'},
{time:'2025-11-19 16:50:05', user:'B002', api:'Update', result:'F', ip:'192.168.2.11', type:'Data', detail:'更新失敗'},
{time:'2025-11-20 12:45:30', user:'B003', api:'GetData', result:'F', ip:'192.168.2.12', type:'Data', detail:'資料不存在'},
{time:'2025-11-21 09:15:00', user:'B004', api:'Update', result:'S', ip:'192.168.2.13', type:'Data', detail:'更新成功'},
{time:'2025-11-21 10:35:20', user:'B005', api:'GetData', result:'S', ip:'192.168.2.14', type:'Data', detail:'取得資料成功'},

{time:'2025-11-18 11:05:10', user:'C001', api:'Restart', result:'S', ip:'192.168.3.10', type:'System', detail:'系統重啟成功'},
{time:'2025-11-19 14:25:40', user:'C002', api:'Restart', result:'F', ip:'192.168.3.11', type:'System', detail:'重啟失敗'},
{time:'2025-11-20 15:50:30', user:'C003', api:'Backup', result:'S', ip:'192.168.3.12', type:'System', detail:'備份完成'},
{time:'2025-11-20 16:15:45', user:'C004', api:'Backup', result:'F', ip:'192.168.3.13', type:'System', detail:'備份失敗'},
{time:'2025-11-21 09:45:20', user:'C005', api:'Restart', result:'S', ip:'192.168.3.14', type:'System', detail:'系統重啟成功'},

{time:'2025-11-18 13:10:10', user:'D001', api:'GenerateReport', result:'S', ip:'192.168.4.10', type:'Report', detail:'報表產生成功'},
{time:'2025-11-19 15:30:05', user:'D002', api:'GenerateReport', result:'F', ip:'192.168.4.11', type:'Report', detail:'報表產生失敗'},
{time:'2025-11-20 14:50:20', user:'D003', api:'GenerateReport', result:'S', ip:'192.168.4.12', type:'Report', detail:'報表產生成功'},
{time:'2025-11-20 16:20:40', user:'D004', api:'GenerateReport', result:'F', ip:'192.168.4.13', type:'Report', detail:'資料不足，產生失敗'},
{time:'2025-11-21 10:05:55', user:'D005', api:'GenerateReport', result:'S', ip:'192.168.4.14', type:'Report', detail:'報表產生成功'}
];

/*生成 Tabs 與表格框架*/
const types = [...new Set(apiData.map(d => d.type))];
const tabList = $("#apiTab");
const tabContent = $("#apiTabContent");

types.forEach((type, index) => {
const active = index === 0 ? "active" : "";
tabList.append(`
 <li class="nav-item">
   <a class="nav-link ${active}" data-toggle="tab" href="#content-${type}">${type}</a>
 </li>
`);

tabContent.append(`
 <div class="tab-pane fade show ${active}" id="content-${type}">
   <table class="table table-bordered table-hover">
     <thead>
       <tr>
         <th>紀錄時間</th>
         <th>使用者</th>
         <th>API 名稱</th>
         <th>結果</th>
         <th>IP</th>
         <th>詳細</th>
       </tr>
     </thead>
     <tbody id="tbody-${type}"></tbody>
   </table>
   <!-- 分頁/筆數顯示會插入在這裡 -->
 </div>
`);
});

/*多表格分頁功能*/
const pageSize = 10;
let pageState = {};
types.forEach(t => pageState[t] = 1);

//顯示分頁資料
function showPage(type, page) {
const tbody = document.querySelector(`#tbody-${type}`);
const rows = Array.from(tbody.querySelectorAll(`tr:not(#noDataRow-${type})`));

const total = rows.length;
const totalPages = Math.ceil(total / pageSize) || 1;

pageState[type] = Math.max(1, Math.min(page, totalPages));
const start = (pageState[type] - 1) * pageSize;
const end = start + pageSize;

rows.forEach((row, idx) => {
 row.style.display = (idx >= start && idx < end) ? "" : "none";
});

renderPagination(type, totalPages);
}


function renderPagination(type, totalPages) {
let container = document.getElementById(`pagination-${type}`);

if (!container) {
 container = document.createElement("div");
 container.id = `pagination-${type}`;
 container.className = "mt-3 d-flex justify-content-between align-items-center";
 document.querySelector(`#tbody-${type}`).parentElement.after(container);
}

const rows = Array.from(document.querySelectorAll(`#tbody-${type} tr:not(#noDataRow-${type})`));
const totalRows = rows.length;
const currentPage = pageState[type];
const startIndex = totalRows ? (currentPage - 1) * pageSize + 1 : 0;
const endIndex = totalRows ? Math.min(currentPage * pageSize, totalRows) : 0;

const leftText = `
 <div class="text-muted">
   目前第 <b>${startIndex}</b> – <b>${endIndex}</b> 筆 / 共 <b>${totalRows}</b> 筆
 </div>
`;

let rightHtml = `<ul class="pagination mb-0">`;

rightHtml += `
 <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
   <a class="page-link" href="#" onclick="showPage('${type}', ${currentPage - 1})">上一頁</a>
 </li>`;

for (let i = 1; i <= totalPages; i++) {
 rightHtml += `
   <li class="page-item ${i === currentPage ? "active" : ""}">
     <a class="page-link" href="#" onclick="showPage('${type}', ${i})">${i}</a>
   </li>`;
}

rightHtml += `
 <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
   <a class="page-link" href="#" onclick="showPage('${type}', ${currentPage + 1})">下一頁</a>
 </li>
`;

rightHtml += `</ul>`;
container.innerHTML = leftText + rightHtml;
}

/* 生成表格內容*/
function renderTable() {
types.forEach(type => {
 const tbody = $(`#tbody-${type}`);
 tbody.empty();

 const filtered = apiData.filter(d => d.type === type);

 if (filtered.length === 0) {
   tbody.append(`<tr id="noDataRow-${type}"><td colspan="6">查無此資料</td></tr>`);
 } else {
   filtered.forEach(d => {
     tbody.append(`
       <tr>
         <td>${d.time}</td>
         <td>${d.user}</td>
         <td>${d.api}</td>
         <td>${d.result}</td>
         <td>${d.ip}</td>
         <td><button class="btn btn-info btn-sm" onclick="showDetail(${apiData.indexOf(d)})">詳細</button></td>
       </tr>
     `);
   });
 }

 showPage(type, 1); // 初始化每個 type 第 1 頁
});
}

/*Modal 詳細內容*/
function showDetail(idx) {
const d = apiData[idx];
$('#modalBodyContent').html(`
 <p><b>時間:</b> ${d.time}</p>
 <p><b>使用者:</b> ${d.user}</p>
 <p><b>API 名稱:</b> ${d.api}</p>
 <p><b>結果:</b> ${d.result}</p>
 <p><b>IP:</b> ${d.ip}</p>
 <p><b>詳細:</b> ${d.detail}</p>
`);
$('#detailModal').modal('show');
}

/* 篩選功能 */
function filterTable() {
const start = $('#startDate').val();
const end = $('#endDate').val();
const user = $('#userInput').val().trim();
const apiName = $('#apiNameSelect').val();
const result = $('#statusSelect').val();

if (start && end && new Date(start) > new Date(end)) {
 alert("⚠️ 結束日期不能小於起始日期！");
 return;
}

types.forEach(type => {
 const tbody = $(`#tbody-${type}`);
 tbody.empty();

 const filtered = apiData.filter(d =>
   d.type === type &&
   (!start || new Date(d.time) >= new Date(start)) &&
   (!end || new Date(d.time) <= new Date(end + "T23:59:59")) &&
   (!user || d.user.includes(user)) &&
   (!apiName || d.api === apiName) &&
   (!result || d.result === result)
 );

 if (filtered.length === 0) {
   tbody.append(`<tr id="noDataRow-${type}"><td colspan="6">查無此資料</td></tr>`);
 } else {
   filtered.forEach(d => {
     tbody.append(`
       <tr>
         <td>${d.time}</td>
         <td>${d.user}</td>
         <td>${d.api}</td>
         <td>${d.result}</td>
         <td>${d.ip}</td>
         <td><button class="btn btn-info btn-sm" onclick="showDetail(${apiData.indexOf(d)})">詳細</button></td>
       </tr>
     `);
   });
 }

 showPage(type, 1); // 篩選後重置到第 1 頁
});
}

function resetFilter() {
$('#startDate,#endDate,#userInput,#apiNameSelect,#statusSelect').val('');
renderTable();
}

//頁面初始化/
$(document).ready(function() {
renderTable();

const apiNames = [...new Set(apiData.map(d => d.api))];
apiNames.forEach(name =>
 $('#apiNameSelect').append(`<option value="${name}">${name}</option>`)
);
});

</script>

</body>
</html>
