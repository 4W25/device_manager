<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>更新紀錄查詢</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="../../index.html" class="nav-link">回首頁</a>
      </li>
    </ul>
    <ul class="navbar-nav ml-auto">
      <li class="nav-item">
        <a class="nav-link" data-widget="fullscreen" href="#" role="button">
          <i class="fas fa-expand-arrows-alt"></i>
        </a>
      </li>
    </ul>
  </nav>

  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="../../index.html" class="brand-link">
      <img src="../../dist/img/device01.png" alt="device01" class="brand-image img-circle elevation-3" style="opacity: .8">
      <span class="brand-text font-weight-light">自動化設備管理平臺</span>
    </a>
    <div class="sidebar">
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          <img src="../../dist/img/userNobody.png" class="img-circle elevation-2" alt="User Image">
        </div>
        <div class="info">
          <a href="#" class="d-block">登入者姓名</a>
        </div>
      </div>
      <nav class="mt-2">
        <ul id="sidebarMenu" class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false"></ul>
      </nav>
    </div>
  </aside>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-6"><h1>更新紀錄查詢</h1></div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
              <li class="breadcrumb-item"><a href="../../index.html">首頁</a></li>
              <li class="breadcrumb-item active">設備監控管理 / 更新紀錄查詢</li>
            </ol>
          </div>
        </div>
      </div>
    </section>

    <section class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title"><i class="fas fa-th-large"></i> 更新紀錄表</h3>
              </div>
              <div class="card-body">
                <table id="example1" class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>設備型號</th>
                      <th>設備編號</th>
                      <th>版號</th>
					  <th>狀態</th>
                      <th>派送時間</th>
                    </tr>
                  </thead>
                  <tbody id="deviceTableBody"></tbody>
                  <tfoot></tfoot>
                </table>
              </div>
            </div>
            <div>
              <button type="button" class="btn btn-primary" onclick="cancelAndReturn()">返回</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="main-footer">
    <div class="float-right d-none d-sm-block"><b>Version</b> 3.2.0</div>
    <strong>Copyright &copy; 2014-2024 <a href="https://www.leosys.com/">國眾電腦股份有限公司</a>.</strong> All rights reserved.
  </footer>
</div>

<!-- JS -->
<script src="../../plugins/jquery/jquery.min.js"></script>
<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
<script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
<script src="../../plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
<script src="../../plugins/jszip/jszip.min.js"></script>
<script src="../../plugins/pdfmake/pdfmake.min.js"></script>
<script src="../../plugins/pdfmake/vfs_fonts.js"></script>
<script src="../../plugins/datatables-buttons/js/buttons.html5.min.js"></script>
<script src="../../plugins/datatables-buttons/js/buttons.print.min.js"></script>
<script src="../../plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
<script src="../../dist/js/adminlte.min.js"></script>
<script src="../../data/device_info.js"></script>
<script src="../../data/sidebar_menu.js"></script>
<script src="../../js/sidebar.js"></script>

<script>
$(function () {
  const urlParams = new URLSearchParams(window.location.search);
  const deviceType = urlParams.get('deviceType');
  const deviceCode = urlParams.get('id');

  const tableBody = document.getElementById('deviceTableBody');
  tableBody.innerHTML = "";

  const filteredList = deviceCode
    ? versionHist.filter(v => v.deviceCode === deviceCode)
    : versionHist;
	

  if (filteredList.length > 0) {
    filteredList.forEach(v => {
      const row = document.createElement('tr');
	  	          // 根據狀態選擇 badge 顏色
          const badgeClass =
            v.deviceStatus === "未派送" ? "badge-warning" :
            v.deviceStatus === "已更新" ? "badge-success" :
            v.deviceStatus === "更新失敗" ? "badge-danger" :
            "badge-secondary";
      row.innerHTML = `
        <td>${v.deviceModel}</td>
        <td>${v.deviceCode}</td>
        <td>${v.deviceVersion}</td>
		              <td><span class="badge ${badgeClass}">${v.deviceStatus}</span></td>
        <td>${v.updateTime}</td>
      `;
      tableBody.appendChild(row);
    });
  } else {
    console.log('找不到該設備資料');
  }


// 待用功能 下載:"buttons": [{extend: "copy",filename: getExportFilename},{extend: "csv",filename: getExportFilename},{extend: "excel",filename: getExportFilename},{extend: "pdf",filename: getExportFilename},{extend: "print",filename: getExportFilename}]
  $("#example1").DataTable({
    "responsive": true,
        "lengthChange": false, 
        "autoWidth": false,
        "ordering": false,
		"searching": false,
		"language": {
          "lengthMenu": "每頁顯示 _MENU_ 筆",
          "zeroRecords": "查無資料",
          "info": "顯示第 _START_ 筆到第 _END_ 筆，共 _TOTAL_ 筆",
          "infoFiltered": "(從 _MAX_ 筆資料過濾)",
		  "search": "搜尋：",
          "paginate": {
            "first": "第一頁",
            "last": "最後一頁",
            "next": "下一頁",
            "previous": "上一頁"
          },
        }
		}).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');

  window.cancelAndReturn = function() {
    window.location.href = `deviceStatusQuery.html${deviceType ? '?deviceType=' + encodeURIComponent(deviceType) : ''}`;
  }
});


// 產生檔名函數
function getExportFilename() {
  const tableBody = document.getElementById('deviceTableBody');
  if (tableBody.rows.length === 0) return '更新紀錄';
  
  // 取第一列作為檔名範例
  const firstRow = tableBody.rows[0];
  const deviceModel = firstRow.cells[0].textContent || '設備型號';
  const deviceCode = firstRow.cells[1].textContent || '設備編號';
  
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  
  return `${deviceModel}_${deviceCode}_${yyyy}${mm}${dd}`;
}
</script>
</body>
</html>
