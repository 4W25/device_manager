<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>設備交易代碼設定</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- IonIcons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
  <style>
    .nav-tabs {
      margin-bottom: 20px;
    }

    #deviceTypeTable th:nth-child(1),
    #deviceTypeTable td:nth-child(1) {
      display: none;
    }
  </style>
</head>

<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <!-- Navbar-->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <!-- 上方行列 -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="../../index.html" class="nav-link">回首頁</a>
        </li>
      </ul>

      <!-- Right navbar links -->
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" data-widget="fullscreen" href="#" role="button">
            <i class="fas fa-expand-arrows-alt"></i>
          </a>
        </li>
      </ul>
    </nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container 側邊欄位 -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <!-- Brand Logo -->
      <a href="../../index.html" class="brand-link">
        <img src="../../dist/img/device01.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
          style="opacity: .8">
        <span class="brand-text font-weight-light">設備監控管理後台</span>
      </a>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Sidebar user (optional) -->
        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
          <div class="image">
            <img src="../../dist/img/userNobody.png" class="img-circle elevation-2" alt="User Image">
          </div>
          <div class="info">
            <a href="#" class="d-block">登入者姓名</a>
          </div>
        </div>

        <!-- Sidebar Menu -->
        <nav class="mt-2">
          <ul id="sidebarMenu" class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
            data-accordion="false">
          </ul>
        </nav>
        <!-- /.sidebar-menu -->
      </div>
      <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <section class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1>設備交易代碼設定總覽頁</h1>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="../../index.html">首頁</a></li>
                <li class="breadcrumb-item active">設備監控管理 / 設備交易代碼設定</li>
              </ol>
            </div>
          </div>
        </div>
        <!-- /.container-fluid -->
      </section>

      <!-- Main content -->
      <section class="content">
        <div class="container-fluid">
          <div class="card card-default card-outline">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-th-large"></i>
                設備交易代碼
              </h3>
            </div>
            <div class="card-body">
              <!--表頭內容-->
              <h4>透過設備類型分頁</h4>
              <!-- Tab 清單容器 -->
              <ul class="nav nav-tabs" id="device-tabs" role="tablist"></ul>
              <!-- 每個 tab 對應的內容（由 JS 產生） -->
              <div class="tab-content" id="device-tab-content"></div>
            </div>
            <!-- /.card -->
          </div>
          <!-- /.card -->
        </div>
        <!-- /.container-fluid -->
      </section>
      <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    <footer class="main-footer">
      <div class="float-right d-none d-sm-block">
        <b>Version</b> 3.2.0
      </div>
      <strong>Copyright &copy; 2014-2024
        <a href="https://www.leosys.com/">國眾電腦股份有限公司</a>.
      </strong> All rights reserved.
    </footer>

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
      <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->
  </div>
  <!-- ./wrapper -->

  <!-- jQuery -->
  <script src="../../plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables  & Plugins -->
  <script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
  <script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
  <script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
  <script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
  <script src="../../plugins/jszip/jszip.min.js"></script>
  <script src="../../plugins/pdfmake/pdfmake.min.js"></script>
  <script src="../../plugins/pdfmake/vfs_fonts.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.html5.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.print.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
  <!-- AdminLTE App -->
  <script src="../../dist/js/adminlte.min.js"></script>
  <!-- 假資料存放區 -->
  <script src="../../data/deviceType_info.js"></script>
  <!-- 左側欄動態生成 -->
  <script src="../../data/sidebar_menu.js"></script>
  <script src="../../js/sidebar.js"></script>
  <script>
    $(function () {
      deviceTypeDataList.forEach((type, index) => {
        const typeId = type.deviceTypeCode;
        const typeName = type.deviceTypeName;
        const isActive = index === 0;

        createTab(typeId, typeName, isActive);
        renderDeviceTableByType(typeId);
        initializeDataTable(`table-${typeId}`, typeId);
      });

      function createTab(typeId, typeName, isActive) {
        $("#device-tabs").append(`
      <li class="nav-item">
        <a class="nav-link ${isActive ? "active" : ""}" id="tab-${typeId}" data-toggle="tab"
          href="#pane-${typeId}" role="tab" aria-selected="${isActive}">${typeName}</a>
      </li>
    `);

        $("#device-tab-content").append(`
      <div class="tab-pane fade ${isActive ? "show active" : ""}" id="pane-${typeId}" role="tabpanel">
        <section class="content">
          <div class="container-fluid">
            <div class="card">
              <div class="card-body">
                <table id="table-${typeId}" class="table table-bordered table-hover">
                  <thead>
                    <tr>
                      <th>設備類型</th>
                      <th>交易代碼</th>
                      <th>交易名稱</th>
                      <th>狀態</th>
                      <th>維護人員</th>
                      <th>維護時間</th>
                      <th>功能</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-${typeId}"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>
      </div>
    `);
      }

      // ✅ 初始化 DataTable 並綁定「新增」按鈕
      function initializeDataTable(tableId) {
        $(`#${tableId}`).DataTable({
          responsive: true,
          lengthChange: false,
          ordering: false,
          autoWidth: false,
          buttons: [
            {
              text: '<i class="fas fa-pencil-alt"></i> 新增',
              className: 'btn btn-secondary',
              action: function () {
                addNewRow(tableId);  // 將 tableId 傳進去，呼叫新增行
              }
            }
          ],
          language: {
            "lengthMenu": "每頁顯示 _MENU_ 筆",
            "zeroRecords": "查無資料",
            "info": "顯示第 _START_ 筆到第 _END_ 筆，共 _TOTAL_ 筆",
            "infoFiltered": "(從 _MAX_ 筆資料過濾)",
            "search": "搜尋：",
            "paginate": {
              "first": "第一頁",
              "last": "最後一頁",
              "next": "下一頁",
              "previous": "上一頁"
            },
          }
        }).buttons().container().appendTo(`#${tableId}_wrapper .col-md-6:eq(0)`);
      }

      // ✅ 新增一筆資料到指定 table 的 tbody
      function addNewRow(tableId) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="text" class="form-control" name="deviceTypeName"></td>
          <td><input type="text" class="form-control" name="transactionCode"></td>
          <td><input type="text" class="form-control" name="transactionName"></td>
          <td>
            <select name="status" class="form-control">
            <option value="true">啟用</option>
            <option value="false">停用</option>
          </select>
        </td>
        <td></td>
        <td></td>
        <td style="text-align: center;">
          <button class="btn btn-sm btn-success" onclick="saveNewRow(this)">送出</button>
          <button class="btn btn-sm btn-secondary" onclick="cancelNewRow(this)">取消</button>
        </td>
        `;
        tbody.prepend(row);
      }
    });

    const statusOrder = { "審核中": 1, "退回": 2, "核准": 3 };
    const statusTextMap = { "true": "啟用", "false": "停用" };
    const statusColorMap = { "啟用": "blue", "停用": "red" };


    function renderDeviceTableByType(typeId) {
      const tbody = document.getElementById(`tbody-${typeId}`);
      if (!tbody) return;
      tbody.innerHTML = "";

      const list = deviceTransactionCodeDataList.filter(d => d.deviceTypeCode === typeId);
      list.sort((a, b) => statusOrder[a.status] - statusOrder[b.status]);

      list.forEach(d => {
        const statusText = statusTextMap[d.status] || d.status;
        const row = document.createElement("tr");
        row.innerHTML = `
        <td>${d.deviceTypeName}</td>
        <td>${d.transactionCode}</td>
        <td>${d.transactionName}</td>
        <td style="color:${statusColorMap[statusText] || 'black'}">${statusText}</td>
        <td>${d.modId}</td>
        <td>${d.modTime}</td>
        <td style="text-align:center;">
          <button class="btn btn-secondary btn-sm mr-1" onclick="editRow(this)">修改</button>
          <button class="btn btn-sm btn-danger" onclick="deleteDevice('${d.codeNo}')">刪除</button>
        </td>
      `;
        tbody.appendChild(row);
      });
    }


    // 刪除設備
    function deleteDevice(codeNo) {
      alert(`設備交易代碼 ${codeNo} 已刪除！（此功能需連接後端）`);
    }

    // 取消新增行
    function cancelNewRow(button) {
      const row = button.closest('tr');
      row.remove();
    }

    // 儲存新增行
    function saveNewRow(button) {
      const row = button.closest('tr');
      const codeNo = row.querySelector('[name="codeNo"]').value;  // 獲取隱藏的 codeNo
      const deviceTypeName = row.querySelector('[name="deviceTypeName"]').value;
      const transactionCode = row.querySelector('[name="transactionCode"]').value;
      const transactionName = row.querySelector('[name="transactionName"]').value;
      const status = row.querySelector('[name="status"]').value;

      alert(`新增設備: codeNo: ${codeNo}, ${deviceTypeName}, ${transactionCode}, ${transactionName}, ${status}`);

      // 新增資料成功後，移除新增行並刷新表格
      row.remove();
      renderDeviceTableByType();
    }

    //編輯行
    function editRow(button) {
      const row = button.closest('tr');
      const cells = row.querySelectorAll('td');

      if (!row || !cells || row.classList.contains('editing')) return;

      // 儲存 codeNo 到 row 的 dataset（若有隱藏欄位）
      const hiddenInput = cells[0].querySelector('input[name="codeNo"]');
      if (hiddenInput) {
        row.dataset.codeNo = hiddenInput.value;
      }

      const currentStatusText = cells[3].textContent.trim();  // 第 4 欄為「狀態」
      const currentStatus = currentStatusText === "啟用" ? "true" : "false";

      // 轉成 input 欄位
      cells[0].innerHTML = `<input type="text" class="form-control" name="deviceTypeName" value="${cells[0].textContent.trim()}">`;
      cells[1].innerHTML = `<input type="text" class="form-control" name="transactionCode" value="${cells[1].textContent.trim()}">`;
      cells[2].innerHTML = `<input type="text" class="form-control" name="transactionName" value="${cells[2].textContent.trim()}">`;
      cells[3].innerHTML = `
        <select name="status" class="form-control">
          <option value="true" ${currentStatus === "true" ? "selected" : ""}>啟用</option>
          <option value="false" ${currentStatus === "false" ? "selected" : ""}>停用</option>
        </select>
      `;

      // 功能欄：換成送出 / 取消按鈕
      const actionCell = cells[6];  // 最後一欄
      actionCell.innerHTML = `
        <button class="btn btn-sm btn-success" onclick="saveRow(this)">送出</button>
        <button class="btn btn-sm btn-secondary" onclick="cancelEditRow(this)">取消</button>
      `;

      row.classList.add('editing');
    }

    // 儲存編輯行
    function saveRow(button) {
      const row = button.closest('tr');
      const tableId = row.closest('table').id;
      const typeId = tableId.replace("table-", "");

      const deviceTypeName = row.querySelector('[name="deviceTypeName"]').value;
      const transactionCode = row.querySelector('[name="transactionCode"]').value;
      const transactionName = row.querySelector('[name="transactionName"]').value;
      const status = row.querySelector('[name="status"]').value;

      alert(`更新設備：${deviceTypeName}, ${transactionCode}, ${transactionName}, ${status}`);

      row.classList.remove('editing');
      renderDeviceTableByType(typeId); // ✅ 加入 typeId
    }

    // 取消編輯行
    function cancelEditRow(button) {
      const row = button.closest('tr');
      const tableId = row.closest('table').id;
      const typeId = tableId.replace("table-", "");
      row.classList.remove('editing');

      const codeNo = row.dataset.codeNo;
      const originalData = deviceTransactionCodeDataList.find(item => item.codeNo == codeNo);

      if (originalData) {
        const cells = row.querySelectorAll('td');
        const statusText = statusTextMap[originalData.status] || originalData.status;

        cells[0].textContent = originalData.deviceTypeName;
        cells[1].textContent = originalData.transactionCode;
        cells[2].textContent = originalData.transactionName;
        cells[3].textContent = statusText;
        cells[3].style.color = statusColorMap[statusText] || 'black';
        cells[4].textContent = originalData.modId;
        cells[5].textContent = originalData.modTime;
        cells[6].innerHTML = `
      <button class="btn btn-secondary btn-sm mr-1" onclick="editRow(this)">修改</button>
      <button class="btn btn-sm btn-danger" onclick="deleteDevice('${originalData.codeNo}')">刪除</button>
    `;
      } else {
        renderDeviceTableByType(typeId); // ✅ 加入 typeId
      }
    }


  </script>
</body>

</html>