<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>遠端檔案下載</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- Select2 -->
  <link rel="stylesheet" href="../../plugins/select2/css/select2.min.css">
  <link rel="stylesheet" href="../../plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
  <link rel="stylesheet" href="../../plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../dist/css/adminlte.min.css">
  <style>
    .nav-tabs {
      margin-bottom: 20px;
    }
  </style>
</head>

<body class="hold-transition sidebar-mini">
  <div class="wrapper">
    <!-- Navbar-->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
      <!-- 上方行列 -->
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
        </li>
        <li class="nav-item d-none d-sm-inline-block">
          <a href="../../index.html" class="nav-link">回首頁</a>
        </li>
      </ul>

      <!-- Right navbar links -->
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a class="nav-link" data-widget="fullscreen" href="#" role="button">
            <i class="fas fa-expand-arrows-alt"></i>
          </a>
        </li>
      </ul>
    </nav>

    <!-- Main Sidebar Container 側邊欄位 -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
      <!-- Brand Logo -->
      <a href="../../index.html" class="brand-link">
        <img src="../../dist/img/device01.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
          style="opacity: .8">
        <span class="brand-text font-weight-light">自動化設備管理平臺</span>
      </a>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Sidebar user (optional) -->
        <div class="user-panel mt-3 pb-3 mb-3 d-flex">
          <div class="image">
            <img src="../../dist/img/userNobody.png" class="img-circle elevation-2" alt="User Image">
          </div>
          <div class="info">
            <a href="#" class="d-block">登入者姓名</a>
          </div>
        </div>

        <!-- Sidebar Menu -->
        <nav class="mt-2">
          <ul id="sidebarMenu" class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
            data-accordion="false">
          </ul>
        </nav>
      </div>
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
      <!-- Content Header (Page header) -->
      <section class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1>遠端檔案下載</h1>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="../../index.html">首頁</a></li>
                <li class="breadcrumb-item active">基本管理 / 遠端檔案下載</li>
              </ol>
            </div>
          </div>
        </div>
      </section>
      <!-- Main content -->
      <section class="content">
        <div class="container-fluid">
          <!-- 上半部：篩選條件 -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">選擇機台</h3>
            </div>
            <div class="card-body">
              <form class="form-inline">
                <div class="form-group mb-2 mr-3">
                  <label for="deviceTypeSelect" class="mr-2">設備類型</label>
                  <select id="deviceTypeSelect" name="deviceTypeId" class="form-control select2"></select>
                </div>
                <div class="form-group mb-2 mr-3">
                  <label for="selectedDeviceName" class="mr-2">設備機台</label>
                  <div class="input-group" style="width: 350px;">
                    <input type="text" class="form-control" id="selectedDeviceName" placeholder="請選擇機台" readonly>
                    <div class="input-group-append">
                      <button type="button" class="btn btn-info" id="openDeviceModalBtn" disabled>選擇</button>
                    </div>
                  </div>
                </div>
                <button id="fetchFilesBtn" disabled type="button" class="btn btn-primary mb-2">查詢檔案</button>
              </form>
            </div>
          </div>

          <!-- 下半部：查詢結果表格 -->
          <div id="fileListContainer" class="card mt-4" style="display:none;">
            <div class="card-header">
              <h3 class="card-title">可下載檔案清單</h3>
            </div>
            <div class="card-body">
              <table id="fileListTable" class="table table-bordered table-hover mb-0">
                <thead>
                  <tr>         
                    <th class="text-center"><input type="checkbox" id="selectAllFiles"></th>
                    <th>檔名</th>
                    <th>說明</th>
                    <th>大小</th>
                  </tr>
                </thead>
                <tbody id="fileList"></tbody>
              </table>
              <div class="mt-2">
                <button class="btn btn-success" id="downloadZipBtn" style="display:none;">下載 ZIP</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <footer class="main-footer">
      <div class="float-right d-none d-sm-block">
        <b>Version</b> 3.2.0
      </div>
      <strong>Copyright &copy; 2014-2024
        <a href="https://www.leosys.com/">國眾電腦股份有限公司</a>.
      </strong> All rights reserved.
    </footer>
  </div>

  <!-- 彈窗：設備機台選擇 -->
  <div class="modal fade" id="deviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">選擇設備機台</h5>
          <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        </div>
        <div class="modal-body">
          <table id="deviceTable" class="table table-bordered table-hover">
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery -->
  <script src="../../plugins/jquery/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- Select2 -->
  <script src="../../plugins/select2/js/select2.full.js"></script>
  <!-- DataTables  & Plugins -->
  <script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
  <script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
  <script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
  <script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
  <script src="../../plugins/jszip/jszip.min.js"></script>
  <script src="../../plugins/pdfmake/pdfmake.min.js"></script>
  <script src="../../plugins/pdfmake/vfs_fonts.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.html5.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.print.min.js"></script>
  <script src="../../plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
  <!-- AdminLTE App -->
  <script src="../../dist/js/adminlte.min.js"></script>
  <!-- 假資料存放區 -->
  <script src="../../data/deviceType_info.js"></script>
  <!-- 左側欄動態生成 -->
  <script src="../../data/sidebar_menu.js"></script>
  <script src="../../js/sidebar.js"></script>
  <script>

    // 模擬資料-設備機台檔案清單
    const fileData = {
      'A012001601': [
        { name: 'log1.txt', desc: '交易紀錄', size: '12KB' },
        { name: 'log2.txt', desc: '錯誤日誌', size: '8KB' }
      ],
      'A012001602': [
        { name: 'update.bin', desc: '更新檔', size: '5MB' }
      ],
      'A012200901': [
        { name: 'cfile1.log', desc: '日誌', size: '15KB' }
      ],
      'A012200902': [
        { name: 'oth1.dat', desc: '資料檔', size: '20KB' }
      ]
    };

    // 選擇設備類型- 初始化
    const deviceTypeSelectList = deviceTypeList.map(item => ({
      value: item.deviceTypeCode,
      text: item.deviceTypeName + ' (' + item.deviceTypeCode + ')'
    }));
    populateSelect2($('#deviceTypeSelect'), deviceTypeSelectList, '請選擇');

    // 選擇設備類型- 動態邏輯
    $('#deviceTypeSelect').on('change', function () {
      const selectedDeviceType = $(this).val();
      console.log('Selected Device Type:', selectedDeviceType);
      $('#selectedDeviceName').val('');
      $('#fetchFilesBtn').prop('disabled', true);
      $('#openDeviceModalBtn').prop('disabled', !selectedDeviceType);

      // 清除 DataTable（避免切換類型後殘留）
      if ($.fn.DataTable.isDataTable('#deviceTable')) {
        $('#deviceTable').DataTable().clear().destroy();
      }
    });

    // 選擇設備- 設備機台彈窗
    $('#openDeviceModalBtn').on('click', function () {
      const selectType = $('#deviceTypeSelect').val();
      const deviceListOfType = deviceDataList.filter(d => d.deviceTypeCode === selectType);

      // 防止 DataTable 重複初始化
      if ($.fn.DataTable.isDataTable('#deviceTable')) {
        $('#deviceTable').DataTable().clear().destroy();
      }

      $("#deviceTable").DataTable({
        responsive: true,
        lengthChange: false,
        autoWidth: false,
        ordering: false,
        data: deviceListOfType,
        columns: [
          {
            data: null, title: "選擇", className: "text-center", width: "100px",
            render: function (data, type, row) {
              return `<button type="button" class="btn btn-sm btn-primary select-device-btn" data-id="${row.deviceNo}" data-locate="${row.deviceLocate}">選擇</button>`;
            }
          },
          { data: "deviceNo", title: "設備編號" },
          { data: "deviceLocate", title: "設備位置" }
        ],
        language: {
          search: "搜尋：",
          lengthMenu: "每頁顯示 _MENU_ 筆",
          zeroRecords: "查無資料",
          info: "顯示第 _START_ 筆到第 _END_ 筆，共 _TOTAL_ 筆",
          infoEmpty: "",
          infoFiltered: "",
          paginate: { first: "第一頁", last: "最後一頁", next: "下一頁", previous: "上一頁" }
        }
      });

      $('#deviceModal').modal('show');
    });

    // 點選某個機台
    $(document).on('click', '.select-device-btn', function () {
      const id = $(this).data('id');
      const locate = $(this).data('locate');

      // 帶回主畫面欄位
      $('#selectedDeviceName').val(`${id} - ${locate}`);
      $('#selectedDeviceName').data('deviceNo', id);

      $('#deviceModal').modal('hide');

      // 啟用查詢按鈕
      $('#fetchFilesBtn').prop('disabled', false);
    });

    // 查詢檔案清單
    $('#fetchFilesBtn').on('click', function () {
      const deviceId = $('#selectedDeviceName').data('deviceNo');
      const files = fileData[deviceId] || [];

      const html = files.map((f, idx) => `
        <tr>
          <td class="text-center">
            <input type="checkbox" value="${f.name}" class="file-checkbox">
          </td>
          <td>${f.name}</td>
          <td>${f.desc}</td>
          <td>${f.size}</td>
        </tr>
      `).join('');

      $('#fileList').html(html);
      $('#fileListContainer').show();
      $('#downloadZipBtn').show();
    });

    // 全選
    $('#selectAllFiles').on('change', function() {
      const checked = $(this).prop('checked');
      $('.file-checkbox').prop('checked', checked);
    });

    // 下載 ZIP
    $('#downloadZipBtn').on('click', function () {
      const selected = $('.file-checkbox:checked').map(function () {
        return this.value;
      }).get();

      if (selected.length === 0) {
        alert("請至少勾選一個檔案");
        return;
      }

      alert("將下載 ZIP：\n" + selected.join('\n'));
      // TODO：呼叫後端 API 下載 ZIP
    });


    /*自訂義select2*/
    function populateSelect2(selectElement, data, placeholder) {
      if (!selectElement.length || !data) return; // 防呆：如果元素不存在或沒有資料，就直接結束
      selectElement.empty(); // 清空舊選項

      const placeholderOption = new Option(placeholder, '', false, false); // 不預設
      selectElement.append(placeholderOption);

      data.forEach(item => {
        // 確保 item.value 和 item.text 存在
        const option = new Option(item.text, item.value, false, false);
        selectElement.append(option);
      });

      // 初始化或重新初始化 Select2
      selectElement.select2({
        theme: 'bootstrap4',
        placeholder: placeholder, // 這裡設定 Select2 自身的 placeholder
        allowClear: false        // 允許清除選擇，清除後會顯示 placeholder
      });

      if (!selectElement.val() && placeholder) {
        selectElement.val('').trigger('change'); // 選中 value 為空字串的選項
      }
    }
  </script>
</body>

</html>